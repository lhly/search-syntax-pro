# éœ€æ±‚ç¡®è®¤æ–‡æ¡£ - æ”¹è¿›å‹æ‚¬æµ®é¢æ¿äº¤äº’

## ğŸ“‹ åŸºæœ¬ä¿¡æ¯

- **åŠŸèƒ½åç§°**: æ”¹è¿›å‹æ‚¬æµ®é¢æ¿äº¤äº’ (Improved Floating Panel)
- **åŠŸèƒ½ä»£å·**: `improved-floating-panel`
- **ç›®æ ‡ç‰ˆæœ¬**: v1.7.3+
- **ä¼˜å…ˆçº§**: é«˜
- **åˆ›å»ºæ—¶é—´**: 2025-11-20
- **éœ€æ±‚çŠ¶æ€**: âœ… å·²ç¡®è®¤ (è´¨é‡è¯„åˆ†: 94/100)

---

## ğŸ¯ åŸå§‹éœ€æ±‚

**ç”¨æˆ·è¯·æ±‚**: "è¯·ä½ å®ç°æ–¹æ¡ˆ 2"

**æ–¹æ¡ˆ2å®šä¹‰** (æ¥è‡ªä¹‹å‰å¯¹è¯):
> æ”¹è¿›å‹æ‚¬æµ®é¢æ¿ - ä¼˜åŒ–ç°æœ‰çš„æ‚¬æµ®æŒ‰é’®åŠŸèƒ½ï¼Œå¯ç”¨å¹¶æ”¹è¿› `FEATURE_FLAGS.enableFloatingButton`ï¼Œå®ç°ç±»ä¼¼ Grammarly çš„ä¼˜é›…äº¤äº’ä½“éªŒã€‚

---

## ğŸ—ï¸ ä»“åº“ä¸Šä¸‹æ–‡åˆ†æ

### ç°æœ‰åŸºç¡€è®¾æ–½

**é¡¹ç›®ç±»å‹**: Chrome Extension (Manifest V3)
**æŠ€æœ¯æ ˆ**: React 18 + TypeScript 5 + Vite 5
**å½“å‰ç‰ˆæœ¬**: v1.7.2

### ç›¸å…³ç°æœ‰ä»£ç 

1. **Content Script**: `/src/content/index.ts`
   - å·²æœ‰ `injectSearchFeatures()` å‡½æ•°æ¡†æ¶
   - åŠŸèƒ½å¼€å…³: `FEATURE_FLAGS.enableFloatingButton = false` (å½“å‰ç¦ç”¨)
   - å·²æœ‰æœç´¢å¼•æ“æ£€æµ‹é€»è¾‘: `isSearchEnginePage()`

2. **Popup ç»„ä»¶**: `/src/popup/App.tsx`
   - å®Œæ•´çš„è¯­æ³•æ„å»ºå™¨UI
   - React ç»„ä»¶åŒ–æ¶æ„
   - æ”¯æŒ SearchFormã€HistoryManager ç­‰åŠŸèƒ½

3. **æ¶ˆæ¯é€šä¿¡**: `/src/background/index.ts`
   - å·²æœ‰ `chrome.runtime.onMessage` ç›‘å¬å™¨
   - æ”¯æŒ `open_popup`ã€`quick_search` ç­‰æ¶ˆæ¯ç±»å‹

4. **é€‚é…å™¨ç³»ç»Ÿ**: `/src/services/adapters/`
   - å·²æ”¯æŒ Baiduã€Googleã€Bing ç­‰10ä¸ªæœç´¢å¼•æ“
   - é€‚é…å™¨å·¥å‚æ¨¡å¼: `AdapterFactory.createAdapter(url)`

### é›†æˆçº¦æŸ

- **Chrome ç‰ˆæœ¬**: Minimum Chrome 91 (manifest.json å®šä¹‰)
- **CSP ç­–ç•¥**: `script-src 'self'; object-src 'self'`
- **å›½é™…åŒ–**: å¿…é¡»æ”¯æŒ zh-CN å’Œ en-US
- **ä¸»é¢˜**: å¿…é¡»æ”¯æŒ light/dark æ¨¡å¼

---

## âœ… éœ€æ±‚æ¾„æ¸…è¿‡ç¨‹

### ç¬¬ä¸€è½®æ¾„æ¸… (2025-11-20)

#### é—®é¢˜ç»„1: äº¤äº’ä½“éªŒç»†èŠ‚

**Q1.1: å†…è”å›¾æ ‡çš„æ˜¾ç¤ºä½ç½®ï¼Ÿ**
- âœ… ç”¨æˆ·é€‰æ‹©: **C - æœç´¢æ¡†ä¸‹æ–¹**
- å†³ç­–è¯´æ˜: ä½œä¸ºæç¤º/å»ºè®®å‡ºç°ï¼Œä¸ä¾µå…¥æœç´¢æ¡†æœ¬èº«

**Q1.2: å›¾æ ‡è§¦å‘æ–¹å¼ï¼Ÿ**
- âœ… ç”¨æˆ·é€‰æ‹©: **B - ç„¦ç‚¹+æ‚¬åœè§¦å‘**
- å†³ç­–è¯´æ˜: ç„¦ç‚¹æ—¶æ˜¾ç¤ºï¼Œé¼ æ ‡æ‚¬åœåœ¨æœç´¢åŒºåŸŸä¹Ÿæ˜¾ç¤º

**Q1.3: æ¨¡æ€é¢æ¿çš„å°ºå¯¸å’Œä½ç½®ï¼Ÿ**
- âœ… ç”¨æˆ·é€‰æ‹©: **B - å¤§é¢æ¿ (800px Ã— 600px)**
- å†³ç­–è¯´æ˜: æä¾›å……è¶³ç©ºé—´å±•ç¤ºå®Œæ•´è¯­æ³•æ„å»ºå™¨

**Q1.4: ç‚¹å‡»é®ç½©å±‚çš„è¡Œä¸ºï¼Ÿ**
- âœ… ç”¨æˆ·é€‰æ‹©: **A - å…³é—­é¢æ¿**
- å†³ç­–è¯´æ˜: ç‚¹å‡»èƒŒæ™¯å³å…³é—­ï¼Œç¬¦åˆæ ‡å‡†æ¨¡æ€æ¡†äº¤äº’

#### é—®é¢˜ç»„2: æŠ€æœ¯å®ç°é€‰æ‹©

**Q2.1: é¢æ¿æ¸²æŸ“æ–¹å¼ï¼Ÿ**
- âœ… ç”¨æˆ·é€‰æ‹©: **A - Shadow DOM + iframe**
- å†³ç­–è¯´æ˜: å®Œå…¨éš”ç¦»æ ·å¼ï¼Œé¿å…ä¸æœç´¢å¼•æ“é¡µé¢å†²çª

**Q2.2: å¦‚ä½•å¤ç”¨ç°æœ‰ popup ç»„ä»¶ï¼Ÿ**
- âœ… ç”¨æˆ·é€‰æ‹©: **C - æ¶ˆæ¯ä¼ é€’æ–¹å¼**
- å†³ç­–è¯´æ˜: content script è´Ÿè´£UIæ¡†æ¶ï¼Œä¸šåŠ¡é€»è¾‘é€šè¿‡æ¶ˆæ¯ä¼ é€’

**Q2.3: æœç´¢å¼•æ“ DOM é€‚é…ç­–ç•¥ï¼Ÿ**
- âœ… ç”¨æˆ·é€‰æ‹©: **A - é…ç½®åŒ–é€‚é…**
- å†³ç­–è¯´æ˜: ä¸ºæ¯ä¸ªæœç´¢å¼•æ“å®šä¹‰é€‰æ‹©å™¨é…ç½®

#### é—®é¢˜ç»„3: è¾¹ç¼˜æƒ…å†µå¤„ç†

**Q3.1: DOM ç»“æ„æ›´æ–°å¤„ç†ï¼Ÿ**
- âœ… ç”¨æˆ·é€‰æ‹©: **A - è‡ªåŠ¨é‡è¯•**
- å†³ç­–è¯´æ˜: ç›‘å¬ DOM å˜åŒ–ï¼Œè‡ªåŠ¨é‡æ–°æ³¨å…¥

**Q3.2: é¢æ¿æ‰“å¼€æ—¶ç„¦ç‚¹ç®¡ç†ï¼Ÿ**
- âœ… ç”¨æˆ·é€‰æ‹©: **A - ä¿æŒæ˜¾ç¤º**
- å†³ç­–è¯´æ˜: é¢æ¿æ‰“å¼€åä¸å—æœç´¢æ¡†ç„¦ç‚¹å½±å“

**Q3.3: å¿«æ·é”®å†²çªå¤„ç†ï¼Ÿ**
- âœ… ç”¨æˆ·é€‰æ‹©: **C - ç¦ç”¨å¿«æ·é”®**
- å†³ç­–è¯´æ˜: é¢æ¿åªèƒ½é€šè¿‡å›¾æ ‡è§¦å‘ï¼Œé¿å…ä¸ç°æœ‰å¿«æ·é”®å†²çª

**Q3.4: å¤šæ ‡ç­¾é¡µå¤„ç†ï¼Ÿ**
- âœ… ç”¨æˆ·é€‰æ‹©: **A - ç‹¬ç«‹çŠ¶æ€**
- å†³ç­–è¯´æ˜: æ¯ä¸ªæ ‡ç­¾é¡µçš„é¢æ¿çŠ¶æ€ç‹¬ç«‹

#### é—®é¢˜ç»„4: åŠŸèƒ½èŒƒå›´ç¡®è®¤

**Q4.1: åŠŸèƒ½å¼€å…³ç­–ç•¥ï¼Ÿ**
- âœ… ç”¨æˆ·é€‰æ‹©: **A - é»˜è®¤å¯ç”¨**
- å†³ç­–è¯´æ˜: å°† `FEATURE_FLAGS.enableFloatingButton` æ”¹ä¸º `true`

**Q4.2: ä¸ç°æœ‰å³é”®èœå•çš„å…³ç³»ï¼Ÿ**
- âœ… ç”¨æˆ·é€‰æ‹©: **A - å¹¶å­˜**
- å†³ç­–è¯´æ˜: ä¸¤ç§å…¥å£éƒ½ä¿ç•™ï¼Œç”¨æˆ·è‡ªç”±é€‰æ‹©

**Q4.3: æ”¯æŒçš„æµè§ˆå™¨ç‰ˆæœ¬ï¼Ÿ**
- âœ… ç”¨æˆ·é€‰æ‹©: **A - Chrome 91+**
- å†³ç­–è¯´æ˜: ä¸ manifest.json ä¿æŒä¸€è‡´

---

## ğŸ“ è¯¦ç»†åŠŸèƒ½è§„æ ¼

### 1. ç”¨æˆ·äº¤äº’æµç¨‹

```
ç”¨æˆ·è®¿é—®æœç´¢å¼•æ“é¡µé¢
  â†“
é¡µé¢åŠ è½½å®Œæˆï¼Œcontent script æ³¨å…¥
  â†“
æ£€æµ‹æœç´¢æ¡†å…ƒç´ 
  â†“
åœ¨æœç´¢æ¡†ä¸‹æ–¹æ³¨å…¥è§¦å‘å›¾æ ‡ (åˆå§‹éšè—)
  â†“
[è§¦å‘æ¡ä»¶1] ç”¨æˆ·ç‚¹å‡»æœç´¢æ¡† (ç„¦ç‚¹äº‹ä»¶)
[è§¦å‘æ¡ä»¶2] é¼ æ ‡æ‚¬åœåœ¨æœç´¢åŒºåŸŸ (hoveräº‹ä»¶)
  â†“
å›¾æ ‡ä»ä¸‹æ–¹æ»‘å…¥/æ·¡å…¥æ˜¾ç¤º
  â†“
ç”¨æˆ·ç‚¹å‡»å›¾æ ‡
  â†“
æ˜¾ç¤ºæ¨¡æ€é®ç½©å±‚ (åŠé€æ˜é»‘è‰²èƒŒæ™¯)
  â†“
åœ¨é®ç½©å±‚ä¸Šæ˜¾ç¤ºå±…ä¸­çš„é¢æ¿ (800Ã—600px)
  â†“
é¢æ¿å†…é€šè¿‡ iframe åŠ è½½ popup/index.html
  â†“
ç”¨æˆ·åœ¨é¢æ¿ä¸­æ„å»ºæœç´¢è¯­æ³•
  â†“
ç‚¹å‡»"åº”ç”¨"æˆ–"æœç´¢"æŒ‰é’®
  â†“
é€šè¿‡æ¶ˆæ¯ä¼ é€’å°†è¯­æ³•å‘é€åˆ° content script
  â†“
content script å°†è¯­æ³•å¡«å……åˆ°æœç´¢æ¡†
  â†“
å…³é—­é¢æ¿å’Œé®ç½©å±‚
  â†“
(å¯é€‰) è‡ªåŠ¨è§¦å‘æœç´¢
```

### 2. æŠ€æœ¯æ¶æ„è®¾è®¡

#### 2.1 ç»„ä»¶ç»“æ„

```
Content Script (src/content/index.ts)
â”œâ”€â”€ FloatingPanelManager (æ–°å¢)
â”‚   â”œâ”€â”€ createTriggerIcon()          // åˆ›å»ºè§¦å‘å›¾æ ‡
â”‚   â”œâ”€â”€ createModalOverlay()         // åˆ›å»ºé®ç½©å±‚
â”‚   â”œâ”€â”€ createPanelIframe()          // åˆ›å»ºé¢æ¿ iframe
â”‚   â”œâ”€â”€ handleShow/Hide()            // æ˜¾ç¤º/éšè—é€»è¾‘
â”‚   â””â”€â”€ handleMessage()              // æ¶ˆæ¯é€šä¿¡
â”œâ”€â”€ SearchEngineAdapter (æ‰©å±•)
â”‚   â”œâ”€â”€ getSearchInputSelector()     // è·å–æœç´¢æ¡†é€‰æ‹©å™¨
â”‚   â”œâ”€â”€ getInsertPosition()          // è·å–å›¾æ ‡æ’å…¥ä½ç½®
â”‚   â””â”€â”€ fillSearchInput(query)       // å¡«å……æœç´¢æ¡†
â””â”€â”€ DOMObserver (æ–°å¢)
    â”œâ”€â”€ observeSearchBox()           // ç›‘å¬æœç´¢æ¡†å˜åŒ–
    â””â”€â”€ reInjectOnChange()           // DOMå˜åŒ–æ—¶é‡æ–°æ³¨å…¥
```

#### 2.2 æœç´¢å¼•æ“é€‚é…é…ç½®

```typescript
// src/config/search-engine-selectors.ts (æ–°å»º)
interface SearchEngineConfig {
  searchInputSelector: string;
  searchContainerSelector: string;
  iconInsertPosition: 'afterend' | 'beforeend';
  iconOffsetY: string; // CSS position offset
}

const ENGINE_CONFIGS: Record<string, SearchEngineConfig> = {
  baidu: {
    searchInputSelector: 'input#kw',
    searchContainerSelector: '#form',
    iconInsertPosition: 'afterend',
    iconOffsetY: '8px'
  },
  google: {
    searchInputSelector: 'input[name="q"]',
    searchContainerSelector: 'div.RNNXgb',
    iconInsertPosition: 'afterend',
    iconOffsetY: '8px'
  },
  bing: {
    searchInputSelector: 'input#sb_form_q',
    searchContainerSelector: 'form#sb_form',
    iconInsertPosition: 'afterend',
    iconOffsetY: '8px'
  }
};
```

#### 2.3 æ¶ˆæ¯é€šä¿¡åè®®

```typescript
// Content Script â†’ Background â†’ Popup
interface MessageProtocol {
  // è¯·æ±‚æ‰“å¼€é¢æ¿ (content â†’ background)
  type: 'open_floating_panel';

  // åº”ç”¨æœç´¢è¯­æ³• (popup â†’ content)
  type: 'apply_search_syntax';
  payload: {
    query: string;
    autoSearch: boolean;
  };

  // å…³é—­é¢æ¿ (popup â†’ content)
  type: 'close_floating_panel';
}
```

### 3. UI/UX è§„æ ¼

#### 3.1 è§¦å‘å›¾æ ‡

**ä½ç½®**: æœç´¢æ¡†ä¸‹æ–¹ï¼Œæ°´å¹³å±…ä¸­
**å°ºå¯¸**: 120px Ã— 32px
**æ ·å¼**:
- èƒŒæ™¯: `bg-blue-500` (ä¸»é¢˜è‰²)
- æ–‡å­—: "âš™ï¸ é«˜çº§è¯­æ³•" (ä¸­æ–‡) / "âš™ï¸ Advanced" (è‹±æ–‡)
- è¾¹æ¡†åœ†è§’: `rounded-md`
- é˜´å½±: `shadow-md`

**åŠ¨ç”»**:
- æ˜¾ç¤º: ä»ä¸‹æ–¹æ·¡å…¥ + å‘ä¸Šæ»‘åŠ¨ (`fadeInUp`, 200ms)
- éšè—: å‘ä¸‹æ·¡å‡º (`fadeOutDown`, 200ms)

**äº¤äº’çŠ¶æ€**:
- Hover: æ”¾å¤§ 1.05 å€ + é˜´å½±åŠ æ·±
- Active: æŒ‰ä¸‹æ•ˆæœ (scale 0.98)

#### 3.2 æ¨¡æ€é®ç½©å±‚

**æ ·å¼**:
- èƒŒæ™¯: `rgba(0, 0, 0, 0.5)` (åŠé€æ˜é»‘è‰²)
- z-index: `9999`
- å…¨å±è¦†ç›–: `fixed top-0 left-0 w-full h-full`

**åŠ¨ç”»**:
- æ˜¾ç¤º: æ·¡å…¥ (`fadeIn`, 200ms)
- éšè—: æ·¡å‡º (`fadeOut`, 200ms)

**äº¤äº’**:
- ç‚¹å‡»é®ç½© â†’ å…³é—­é¢æ¿

#### 3.3 é¢æ¿å®¹å™¨

**å°ºå¯¸**: 800px Ã— 600px
**ä½ç½®**: å±å¹•å±…ä¸­
**æ ·å¼**:
- èƒŒæ™¯: ç™½è‰² (light) / æ·±ç° (dark)
- è¾¹æ¡†åœ†è§’: `rounded-lg`
- é˜´å½±: `shadow-2xl`

**åŠ¨ç”»**:
- æ˜¾ç¤º: ç¼©æ”¾å¼¹å‡º (`zoomIn`, 300ms, ease-out`)
- éšè—: ç¼©æ”¾æ¶ˆå¤± (`zoomOut`, 200ms, ease-in`)

**å†…å®¹**:
- iframe åŠ è½½ `/src/popup/index.html`
- iframe å°ºå¯¸: 100% Ã— 100%
- æ— è¾¹æ¡†: `border: none`

#### 3.4 å“åº”å¼é€‚é…

```css
/* å°å±å¹•é€‚é… (< 900px) */
@media (max-width: 900px) {
  .ssp-panel {
    width: 90vw;
    height: 80vh;
    max-width: 700px;
    max-height: 600px;
  }
}

/* æå°å±å¹• (< 600px) */
@media (max-width: 600px) {
  .ssp-panel {
    width: 95vw;
    height: 90vh;
  }
}
```

### 4. åŠŸèƒ½éœ€æ±‚è¯¦ç»†è¯´æ˜

#### 4.1 è‡ªåŠ¨ DOM æ³¨å…¥

**è§¦å‘æ—¶æœº**:
- é¡µé¢åŠ è½½å®Œæˆ (`DOMContentLoaded`)
- é¡µé¢ URL å˜åŒ– (SPA è·¯ç”±åˆ‡æ¢)
- DOM ç»“æ„å˜åŒ– (MutationObserver)

**æ³¨å…¥é€»è¾‘**:
1. æ£€æµ‹å½“å‰é¡µé¢æ˜¯å¦ä¸ºæœç´¢å¼•æ“
2. ä½¿ç”¨é…ç½®åŒ–é€‰æ‹©å™¨å®šä½æœç´¢æ¡†
3. åœ¨æœç´¢æ¡†ä¸‹æ–¹æ’å…¥è§¦å‘å›¾æ ‡
4. ç»‘å®šç„¦ç‚¹/æ‚¬åœäº‹ä»¶ç›‘å¬å™¨

**å®¹é”™å¤„ç†**:
- å¦‚æœé€‰æ‹©å™¨æœªæ‰¾åˆ°å…ƒç´  â†’ å»¶è¿Ÿ500msé‡è¯• (æœ€å¤š3æ¬¡)
- å¦‚æœæœç´¢å¼•æ“æœªé…ç½® â†’ é™é»˜å¤±è´¥ï¼Œä¸æ³¨å…¥
- å¦‚æœå·²æ³¨å…¥ â†’ è·³è¿‡ï¼Œé¿å…é‡å¤

#### 4.2 ç„¦ç‚¹ä¸æ‚¬åœç®¡ç†

**ç„¦ç‚¹äº‹ä»¶**:
```typescript
searchInput.addEventListener('focus', () => {
  showTriggerIcon();
});

searchInput.addEventListener('blur', () => {
  // å»¶è¿Ÿéšè—ï¼Œé˜²æ­¢ç‚¹å‡»å›¾æ ‡æ—¶è¿‡æ—©æ¶ˆå¤±
  setTimeout(() => {
    if (!isIconHovered && !isPanelOpen) {
      hideTriggerIcon();
    }
  }, 200);
});
```

**æ‚¬åœäº‹ä»¶**:
```typescript
searchContainer.addEventListener('mouseenter', () => {
  showTriggerIcon();
});

searchContainer.addEventListener('mouseleave', () => {
  if (!searchInput.matches(':focus') && !isPanelOpen) {
    hideTriggerIcon();
  }
});
```

#### 4.3 é¢æ¿ç”Ÿå‘½å‘¨æœŸ

**æ‰“å¼€æµç¨‹**:
1. åˆ›å»ºé®ç½©å±‚å…ƒç´  (å¦‚ä¸å­˜åœ¨)
2. åˆ›å»ºé¢æ¿å®¹å™¨ (å¦‚ä¸å­˜åœ¨)
3. åˆ›å»º iframe å¹¶åŠ è½½ popup HTML
4. æ·»åŠ åˆ° Shadow DOM ä¸­
5. æ‰§è¡Œæ˜¾ç¤ºåŠ¨ç”»
6. è®¾ç½® `isPanelOpen = true`

**å…³é—­æµç¨‹**:
1. æ‰§è¡Œéšè—åŠ¨ç”»
2. åŠ¨ç”»ç»“æŸåç§»é™¤é®ç½©å±‚å’Œé¢æ¿
3. æ¸…ç†äº‹ä»¶ç›‘å¬å™¨
4. è®¾ç½® `isPanelOpen = false`

**æ¶ˆæ¯é€šä¿¡**:
- iframe åŠ è½½å®Œæˆ â†’ å‘é€åˆå§‹åŒ–æ¶ˆæ¯
- ç”¨æˆ·ç‚¹å‡»"åº”ç”¨" â†’ popup å‘é€ `apply_search_syntax` æ¶ˆæ¯
- content script æ¥æ”¶ â†’ å¡«å……æœç´¢æ¡† â†’ å…³é—­é¢æ¿

#### 4.4 æœç´¢æ¡†å¡«å……

**å¡«å……é€»è¾‘**:
```typescript
function fillSearchInput(query: string, autoSearch: boolean = false) {
  const searchInput = getSearchInput();

  // è®¾ç½®å€¼
  searchInput.value = query;

  // è§¦å‘ input äº‹ä»¶ (æŸäº›æœç´¢å¼•æ“éœ€è¦)
  searchInput.dispatchEvent(new Event('input', { bubbles: true }));

  // è§¦å‘ change äº‹ä»¶
  searchInput.dispatchEvent(new Event('change', { bubbles: true }));

  // è®¾ç½®ç„¦ç‚¹
  searchInput.focus();

  // å¯é€‰: è‡ªåŠ¨æäº¤æœç´¢
  if (autoSearch) {
    const form = searchInput.closest('form');
    if (form) {
      form.submit();
    }
  }
}
```

#### 4.5 å¤šæ ‡ç­¾é¡µç‹¬ç«‹çŠ¶æ€

**å®ç°æ–¹å¼**:
- æ¯ä¸ªæ ‡ç­¾é¡µçš„ content script ç‹¬ç«‹è¿è¡Œ
- ä¸ä½¿ç”¨ `chrome.storage` å…±äº«é¢æ¿çŠ¶æ€
- æ¯ä¸ªæ ‡ç­¾é¡µçš„é¢æ¿ DOM å…ƒç´ ç‹¬ç«‹åˆ›å»º/é”€æ¯

#### 4.6 å›½é™…åŒ–æ”¯æŒ

**è§¦å‘å›¾æ ‡æ–‡æœ¬**:
```typescript
const iconText = getCurrentLanguage() === 'zh-CN'
  ? 'âš™ï¸ é«˜çº§è¯­æ³•'
  : 'âš™ï¸ Advanced Syntax';
```

**iframe é¡µé¢è¯­è¨€**:
- iframe åŠ è½½çš„ popup ä¼šè‡ªåŠ¨è¯»å– `chrome.storage` ä¸­çš„è¯­è¨€è®¾ç½®
- æ— éœ€é¢å¤–å¤„ç†

#### 4.7 ä¸»é¢˜é€‚é…

**Shadow DOM æ ·å¼**:
```css
/* é®ç½©å±‚æ ¹æ®ç³»ç»Ÿä¸»é¢˜è‡ªåŠ¨é€‚é… */
.ssp-modal-overlay {
  background: rgba(0, 0, 0, 0.5);
}

/* é¢æ¿å®¹å™¨æ ¹æ®ä¸»é¢˜åˆ‡æ¢ */
.ssp-panel-container {
  background: var(--bg-color);
  color: var(--text-color);
}

/* ä» chrome.storage è¯»å–ä¸»é¢˜è®¾ç½®å¹¶æ³¨å…¥ CSS å˜é‡ */
```

### 5. è¾¹ç¼˜æƒ…å†µå¤„ç†

#### 5.1 DOM ç»“æ„å˜åŒ–

**é—®é¢˜**: æœç´¢å¼•æ“é¡µé¢ DOM æ›´æ–°å¯¼è‡´å›¾æ ‡æ¶ˆå¤±

**è§£å†³æ–¹æ¡ˆ**:
```typescript
const observer = new MutationObserver((mutations) => {
  const iconExists = document.querySelector('#ssp-trigger-icon');
  if (!iconExists && isSearchEnginePage()) {
    console.log('[SSP] DOM changed, re-injecting icon');
    setTimeout(() => injectTriggerIcon(), 500);
  }
});

observer.observe(document.body, {
  childList: true,
  subtree: true
});
```

**é™æµä¼˜åŒ–**:
- ä½¿ç”¨ debounce é¿å…é¢‘ç¹é‡æ³¨å…¥
- æœ€å¤šæ¯500msæ£€æŸ¥ä¸€æ¬¡

#### 5.2 iframe åŠ è½½å¤±è´¥

**é—®é¢˜**: iframe æ— æ³•åŠ è½½ popup HTML

**è§£å†³æ–¹æ¡ˆ**:
```typescript
iframe.addEventListener('error', () => {
  console.error('[SSP] Failed to load popup iframe');
  showErrorMessage('é¢æ¿åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
  closePanelAfterDelay(3000);
});

iframe.addEventListener('load', () => {
  console.log('[SSP] Popup iframe loaded successfully');
  initMessageChannel();
});
```

#### 5.3 CSP ç­–ç•¥é˜»æ­¢

**é—®é¢˜**: æŸäº›æœç´¢å¼•æ“çš„ CSP ç­–ç•¥é˜»æ­¢ iframe

**è§£å†³æ–¹æ¡ˆ**:
- ä½¿ç”¨ `chrome.runtime.getURL()` ç¡®ä¿ iframe src ä¸ºæ‰©å±•å†…éƒ¨èµ„æº
- åœ¨ manifest.json çš„ `web_accessible_resources` ä¸­å£°æ˜ popup HTML

```json
{
  "web_accessible_resources": [
    {
      "resources": ["src/popup/index.html", "icons/*"],
      "matches": ["<all_urls>"]
    }
  ]
}
```

#### 5.4 å¿«é€Ÿç‚¹å‡»é˜²æŠ–

**é—®é¢˜**: ç”¨æˆ·å¿«é€Ÿè¿ç»­ç‚¹å‡»å›¾æ ‡å¯¼è‡´å¤šä¸ªé¢æ¿

**è§£å†³æ–¹æ¡ˆ**:
```typescript
let isOpening = false;

function openPanel() {
  if (isOpening || isPanelOpen) {
    return;
  }

  isOpening = true;

  // æ‰§è¡Œæ‰“å¼€é€»è¾‘...

  setTimeout(() => {
    isOpening = false;
  }, 500);
}
```

#### 5.5 ç„¦ç‚¹é™·é˜± (Focus Trap)

**é—®é¢˜**: é¢æ¿æ‰“å¼€åï¼ŒTab é”®å¯èƒ½è·³å‡ºé¢æ¿

**è§£å†³æ–¹æ¡ˆ**:
```typescript
// åœ¨ iframe å†…éƒ¨çš„ popup ç»„ä»¶ä¸­å®ç°ç„¦ç‚¹é™·é˜±
modalElement.addEventListener('keydown', (e) => {
  if (e.key === 'Tab') {
    trapFocusInModal(e);
  }

  if (e.key === 'Escape') {
    closePanel();
  }
});
```

### 6. æ€§èƒ½ä¼˜åŒ–

#### 6.1 æ‡’åŠ è½½ iframe

**ç­–ç•¥**: åªæœ‰åœ¨ç”¨æˆ·ç‚¹å‡»å›¾æ ‡æ—¶æ‰åˆ›å»º iframe

```typescript
let panelIframe: HTMLIFrameElement | null = null;

function openPanel() {
  if (!panelIframe) {
    panelIframe = createPanelIframe();
  }

  showModal();
}
```

#### 6.2 CSS åŠ¨ç”»ç¡¬ä»¶åŠ é€Ÿ

**ä¼˜åŒ–**:
```css
.ssp-panel-container {
  will-change: transform, opacity;
  transform: translateZ(0); /* è§¦å‘ GPU åŠ é€Ÿ */
}
```

#### 6.3 äº‹ä»¶å§”æ‰˜

**ä¼˜åŒ–**: é®ç½©å±‚ç‚¹å‡»äº‹ä»¶ä½¿ç”¨äº‹ä»¶å§”æ‰˜

```typescript
overlay.addEventListener('click', (e) => {
  if (e.target === overlay) {
    closePanel();
  }
});
```

#### 6.4 èŠ‚æµ/é˜²æŠ–

**åº”ç”¨åœºæ™¯**:
- DOM MutationObserver â†’ debounce 500ms
- çª—å£ resize äº‹ä»¶ â†’ throttle 200ms
- é¼ æ ‡ hover äº‹ä»¶ â†’ debounce 100ms

---

## ğŸ¯ éœ€æ±‚è´¨é‡è¯„åˆ† (æœ€ç»ˆ)

åŸºäºè¯¦ç»†çš„éœ€æ±‚æ¾„æ¸…å’Œè§„æ ¼å®šä¹‰ï¼Œé‡æ–°è¯„åˆ†ï¼š

| è¯„ä¼°ç»´åº¦ | å¾—åˆ† | è¯´æ˜ |
|---------|------|------|
| **åŠŸèƒ½æ¸…æ™°åº¦** (30åˆ†) | 28/30 | âœ… äº¤äº’æµç¨‹ã€UIè§„æ ¼ã€åŠ¨ç”»æ•ˆæœå·²æ˜ç¡® |
| **æŠ€æœ¯å…·ä½“æ€§** (25åˆ†) | 24/25 | âœ… Shadow DOMæ¶æ„ã€æ¶ˆæ¯åè®®ã€é€‚é…é…ç½®å·²å®šä¹‰ |
| **å®ç°å®Œæ•´æ€§** (25åˆ†) | 24/25 | âœ… è¾¹ç¼˜æƒ…å†µã€é”™è¯¯å¤„ç†ã€æ€§èƒ½ä¼˜åŒ–å·²è¦†ç›– |
| **ä¸šåŠ¡ä¸Šä¸‹æ–‡** (20åˆ†) | 18/20 | âœ… ç”¨æˆ·ä»·å€¼æ¸…æ™°ï¼Œä¸ç°æœ‰åŠŸèƒ½åè°ƒæ˜ç¡® |

**æœ€ç»ˆæ€»åˆ†**: **94/100** âœ…

**è´¨é‡ç­‰çº§**: Açº§ (ä¼˜ç§€) - å¯ä»¥è¿›å…¥å®ç°é˜¶æ®µ

---

## ğŸ“¦ éœ€æ±‚èŒƒå›´æ€»ç»“

### åŒ…å«åŠŸèƒ½ (In Scope)

âœ… åœ¨æœç´¢æ¡†ä¸‹æ–¹æ³¨å…¥è§¦å‘å›¾æ ‡
âœ… ç„¦ç‚¹+æ‚¬åœåŒè§¦å‘æœºåˆ¶
âœ… å±…ä¸­æ¨¡æ€é¢æ¿ (800Ã—600px)
âœ… Shadow DOM + iframe æ¸²æŸ“éš”ç¦»
âœ… æ¶ˆæ¯ä¼ é€’å¤ç”¨ popup ç»„ä»¶
âœ… é…ç½®åŒ–æœç´¢å¼•æ“é€‚é…
âœ… è‡ªåŠ¨ DOM å˜åŒ–é‡æ³¨å…¥
âœ… å¤šæ ‡ç­¾é¡µç‹¬ç«‹çŠ¶æ€
âœ… ç‚¹å‡»é®ç½©å…³é—­é¢æ¿
âœ… å›½é™…åŒ–å’Œä¸»é¢˜æ”¯æŒ
âœ… é»˜è®¤å¯ç”¨åŠŸèƒ½å¼€å…³
âœ… ä¸å³é”®èœå•å¹¶å­˜
âœ… Chrome 91+ å…¼å®¹æ€§

### ä¸åŒ…å«åŠŸèƒ½ (Out of Scope)

âŒ ä¾§è¾¹æ é¢æ¿æ–¹å¼ (éæœ¬æ–¹æ¡ˆèŒƒå›´)
âŒ æœç´¢æ¡†å†…éƒ¨å›¾æ ‡æ³¨å…¥ (å·²é€‰æ‹©ä¸‹æ–¹ä½ç½®)
âŒ ç”¨æˆ·è‡ªå®šä¹‰é¢æ¿å°ºå¯¸ (å›ºå®š800Ã—600)
âŒ é¢æ¿ä½ç½®æ‹–æ‹½ (å›ºå®šå±…ä¸­)
âŒ å¿«æ·é”®æ‰“å¼€é¢æ¿ (ä»…å›¾æ ‡è§¦å‘)
âŒ å¤šæ ‡ç­¾é¡µçŠ¶æ€å…±äº« (å·²é€‰ç‹¬ç«‹çŠ¶æ€)
âŒ è®¾ç½®é¡µé¢åŠŸèƒ½å¼€å…³ (ç›´æ¥é»˜è®¤å¯ç”¨)

### æœªæ¥å¯èƒ½æ‰©å±• (Future Enhancements)

ğŸ”® æ”¯æŒæ›´å¤šæœç´¢å¼•æ“é€‚é…
ğŸ”® é¢æ¿ä½ç½®è‡ªå®šä¹‰
ğŸ”® å¿«æ·é”®æ‰“å¼€æ”¯æŒ
ğŸ”® é¢æ¿å°ºå¯¸ç”¨æˆ·å¯è°ƒ
ğŸ”® æ‹–æ‹½ç§»åŠ¨é¢æ¿

---

## ğŸš€ å®ç°ä¼˜å…ˆçº§

### P0 - æ ¸å¿ƒåŠŸèƒ½ (å¿…é¡»å®ç°)

1. è§¦å‘å›¾æ ‡æ³¨å…¥å’Œæ˜¾ç¤º/éšè—é€»è¾‘
2. æ¨¡æ€é®ç½©å±‚å’Œé¢æ¿å®¹å™¨
3. iframe åŠ è½½å’Œæ¶ˆæ¯é€šä¿¡
4. æœç´¢æ¡†å¡«å……åŠŸèƒ½
5. æœç´¢å¼•æ“é€‚é…é…ç½® (Baiduã€Googleã€Bing)

### P1 - é‡è¦åŠŸèƒ½ (åº”è¯¥å®ç°)

6. DOM å˜åŒ–è‡ªåŠ¨é‡æ³¨å…¥
7. ç„¦ç‚¹å’Œæ‚¬åœäº‹ä»¶ç®¡ç†
8. åŠ¨ç”»æ•ˆæœå’Œè¿‡æ¸¡
9. é”™è¯¯å¤„ç†å’Œå®¹é”™
10. å›½é™…åŒ–å’Œä¸»é¢˜é€‚é…

### P2 - ä¼˜åŒ–åŠŸèƒ½ (å¯ä»¥å®ç°)

11. æ€§èƒ½ä¼˜åŒ– (æ‡’åŠ è½½ã€ç¡¬ä»¶åŠ é€Ÿ)
12. å“åº”å¼å¸ƒå±€é€‚é…
13. ç„¦ç‚¹é™·é˜±å’Œé”®ç›˜å¯¼èˆª
14. æ›´å¤šæœç´¢å¼•æ“æ”¯æŒ

---

## ğŸ“ éªŒæ”¶æ ‡å‡†

### åŠŸèƒ½éªŒæ”¶

- [ ] åœ¨ Baidu.com æœç´¢æ¡†ä¸‹æ–¹èƒ½çœ‹åˆ°è§¦å‘å›¾æ ‡
- [ ] åœ¨ Google.com æœç´¢æ¡†ä¸‹æ–¹èƒ½çœ‹åˆ°è§¦å‘å›¾æ ‡
- [ ] åœ¨ Bing.com æœç´¢æ¡†ä¸‹æ–¹èƒ½çœ‹åˆ°è§¦å‘å›¾æ ‡
- [ ] æœç´¢æ¡†è·å¾—ç„¦ç‚¹æ—¶ï¼Œå›¾æ ‡è‡ªåŠ¨æ˜¾ç¤º
- [ ] é¼ æ ‡æ‚¬åœåœ¨æœç´¢åŒºåŸŸæ—¶ï¼Œå›¾æ ‡è‡ªåŠ¨æ˜¾ç¤º
- [ ] å¤±å»ç„¦ç‚¹ä¸”æ— æ‚¬åœæ—¶ï¼Œå›¾æ ‡è‡ªåŠ¨éšè—
- [ ] ç‚¹å‡»å›¾æ ‡åï¼Œæ˜¾ç¤ºå±…ä¸­çš„800Ã—600æ¨¡æ€é¢æ¿
- [ ] é¢æ¿å†…æ­£ç¡®åŠ è½½ popup ç»„ä»¶
- [ ] åœ¨é¢æ¿ä¸­æ„å»ºè¯­æ³•åï¼Œç‚¹å‡»"åº”ç”¨"èƒ½å¡«å……åˆ°æœç´¢æ¡†
- [ ] ç‚¹å‡»é®ç½©å±‚èƒŒæ™¯èƒ½å…³é—­é¢æ¿
- [ ] æŒ‰ ESC é”®èƒ½å…³é—­é¢æ¿
- [ ] é¢æ¿æ‰“å¼€åä¸å—æœç´¢æ¡†ç„¦ç‚¹å½±å“

### æŠ€æœ¯éªŒæ”¶

- [ ] ä½¿ç”¨ Shadow DOM éš”ç¦»æ ·å¼
- [ ] ä½¿ç”¨ iframe åŠ è½½ popup HTML
- [ ] é€šè¿‡æ¶ˆæ¯ä¼ é€’ä¸ popup é€šä¿¡
- [ ] é…ç½®åŒ–é€‚é…å™¨æ”¯æŒå¤šæœç´¢å¼•æ“
- [ ] MutationObserver ç›‘å¬ DOM å˜åŒ–
- [ ] è‡ªåŠ¨é‡æ³¨å…¥åŠŸèƒ½æ­£å¸¸å·¥ä½œ
- [ ] å¤šä¸ªæ ‡ç­¾é¡µç‹¬ç«‹è¿è¡Œï¼Œäº’ä¸å¹²æ‰°
- [ ] ä¸­è‹±æ–‡ç•Œé¢æ­£ç¡®æ˜¾ç¤º
- [ ] äº®è‰²/æš—è‰²ä¸»é¢˜æ­£ç¡®é€‚é…
- [ ] åœ¨ Chrome 91+ ç‰ˆæœ¬æ­£å¸¸è¿è¡Œ

### å…¼å®¹æ€§éªŒæ”¶

- [ ] Chrome 91 æµè§ˆå™¨æµ‹è¯•é€šè¿‡
- [ ] Chrome æœ€æ–°ç‰ˆæœ¬æµ‹è¯•é€šè¿‡
- [ ] Windows ç³»ç»Ÿæµ‹è¯•é€šè¿‡
- [ ] macOS ç³»ç»Ÿæµ‹è¯•é€šè¿‡
- [ ] Linux ç³»ç»Ÿæµ‹è¯•é€šè¿‡ (å¯é€‰)

### æ€§èƒ½éªŒæ”¶

- [ ] å›¾æ ‡æ˜¾ç¤º/éšè—åŠ¨ç”»æµç•… (>60fps)
- [ ] é¢æ¿æ‰“å¼€/å…³é—­åŠ¨ç”»æµç•… (>60fps)
- [ ] é¡µé¢åŠ è½½æ—¶æ³¨å…¥ä¸é˜»å¡ä¸»çº¿ç¨‹
- [ ] å†…å­˜å ç”¨åˆç† (<10MB å¢é‡)
- [ ] ä¸å½±å“æœç´¢å¼•æ“é¡µé¢åŸæœ‰åŠŸèƒ½

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [ä»“åº“ä¸Šä¸‹æ–‡åˆ†æ](./00-repository-context.md)
- [æŠ€æœ¯å®ç°è§„æ ¼](./requirements-spec.md) (å¾…ç”Ÿæˆ)
- [ä»£ç å®ç°](../../src/content/) (å¾…å¼€å‘)

---

## âœï¸ å˜æ›´å†å²

| ç‰ˆæœ¬ | æ—¥æœŸ | å˜æ›´å†…å®¹ | è´Ÿè´£äºº |
|------|------|---------|--------|
| v1.0 | 2025-11-20 | åˆå§‹ç‰ˆæœ¬ï¼Œå®Œæˆéœ€æ±‚æ¾„æ¸… | requirements-pilot |

---

**æ–‡æ¡£çŠ¶æ€**: âœ… å·²ç¡®è®¤ï¼Œå¾…ç”¨æˆ·å®¡æ‰¹è¿›å…¥å®ç°é˜¶æ®µ
