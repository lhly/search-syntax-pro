<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸»é¢˜åŠŸèƒ½æµ‹è¯• - SSP</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }

        .test-section {
            border: 2px solid #ccc;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            background: #f9f9f9;
        }

        html.dark .test-section {
            background: #1f2937;
            border-color: #374151;
            color: white;
        }

        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
        }

        .status.pass {
            background: #d4edda;
            color: #155724;
        }

        html.dark .status.pass {
            background: #1e4620;
            color: #7aff7a;
        }

        .status.fail {
            background: #f8d7da;
            color: #721c24;
        }

        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        button.light {
            background: #fff;
            color: #000;
            border: 2px solid #ddd;
        }

        button.dark {
            background: #1f2937;
            color: white;
            border: 2px solid #374151;
        }

        button.auto {
            background: linear-gradient(90deg, #fff 50%, #1f2937 50%);
            color: #000;
            border: 2px solid #888;
        }

        code {
            background: #e0e0e0;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }

        html.dark code {
            background: #374151;
        }
    </style>
</head>
<body>
    <h1>ğŸ¨ ä¸»é¢˜åŠŸèƒ½æµ‹è¯•é¡µé¢</h1>

    <div class="test-section">
        <h2>1. å½“å‰çŠ¶æ€</h2>
        <div id="currentStatus"></div>
    </div>

    <div class="test-section">
        <h2>2. æ‰‹åŠ¨æµ‹è¯•ä¸»é¢˜åˆ‡æ¢</h2>
        <p>ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æµ‹è¯•ä¸»é¢˜åˆ‡æ¢åŠŸèƒ½ï¼š</p>
        <button class="light" onclick="testTheme('light')">â˜€ï¸ Light Mode</button>
        <button class="dark" onclick="testTheme('dark')">ğŸŒ™ Dark Mode</button>
        <button class="auto" onclick="testTheme('auto')">ğŸ”„ Auto Mode</button>
    </div>

    <div class="test-section">
        <h2>3. è‡ªåŠ¨æµ‹è¯•ç»“æœ</h2>
        <div id="autoTestResults"></div>
    </div>

    <div class="test-section">
        <h2>4. æµ‹è¯•è¯´æ˜</h2>
        <ul>
            <li>âœ… <strong>Light Mode</strong>: é¡µé¢åº”è¯¥æ˜¾ç¤ºäº®è‰²èƒŒæ™¯</li>
            <li>âœ… <strong>Dark Mode</strong>: é¡µé¢åº”è¯¥æ˜¾ç¤ºæš—è‰²èƒŒæ™¯</li>
            <li>âœ… <strong>Auto Mode</strong>: é¡µé¢åº”è¯¥è·Ÿéšç³»ç»Ÿä¸»é¢˜</li>
            <li>âœ… Storage åŒæ­¥: è®¾ç½®åº”è¯¥ä¿å­˜åˆ° <code>chrome.storage.local</code></li>
            <li>âœ… DOM æ›´æ–°: <code>&lt;html&gt;</code> å…ƒç´ åº”è¯¥æœ‰ <code>dark</code> æˆ– <code>light</code> class</li>
        </ul>
    </div>

    <script>
        // æ˜¾ç¤ºå½“å‰çŠ¶æ€
        function updateCurrentStatus() {
            const html = document.documentElement;
            const hasLight = html.classList.contains('light');
            const hasDark = html.classList.contains('dark');
            const dataTheme = html.getAttribute('data-theme');

            const statusHTML = `
                <div class="status ${hasDark || hasLight ? 'pass' : 'fail'}">
                    <strong>DOM Classes:</strong><br>
                    - light: ${hasLight}<br>
                    - dark: ${hasDark}<br>
                    <strong>Data Attribute:</strong> data-theme="${dataTheme}"
                </div>
            `;

            document.getElementById('currentStatus').innerHTML = statusHTML;
        }

        // æµ‹è¯•ä¸»é¢˜åˆ‡æ¢
        async function testTheme(theme) {
            console.log(`ğŸ§ª Testing theme: ${theme}`);

            try {
                // 1. ä¿å­˜åˆ° storage
                const settings = await chrome.storage.local.get('user_settings');
                const newSettings = {
                    ...(settings.user_settings || {}),
                    theme: theme
                };

                await chrome.storage.local.set({ user_settings: newSettings });
                console.log('âœ… Saved to storage:', newSettings);

                // 2. æ‰‹åŠ¨åº”ç”¨ä¸»é¢˜ï¼ˆæ¨¡æ‹Ÿ ThemeProvider çš„é€»è¾‘ï¼‰
                const root = document.documentElement;
                root.classList.remove('light', 'dark');

                let effectiveTheme = theme;
                if (theme === 'auto') {
                    effectiveTheme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
                }

                root.classList.add(effectiveTheme);
                root.setAttribute('data-theme', effectiveTheme);

                console.log('âœ… Applied theme to DOM:', effectiveTheme);

                // 3. æ›´æ–°çŠ¶æ€æ˜¾ç¤º
                updateCurrentStatus();

                // 4. æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                alert(`âœ… ä¸»é¢˜å·²åˆ‡æ¢åˆ°: ${theme}\nå®é™…åº”ç”¨: ${effectiveTheme}\n\nè¯·æ‰“å¼€ Options æˆ– Popup é¡µé¢éªŒè¯ä¸»é¢˜æ˜¯å¦åŒæ­¥ï¼`);

            } catch (error) {
                console.error('âŒ Theme test failed:', error);
                alert(`âŒ æµ‹è¯•å¤±è´¥: ${error.message}`);
            }
        }

        // è‡ªåŠ¨æµ‹è¯•
        async function runAutoTests() {
            const results = [];

            // æµ‹è¯• 1: Chrome Storage API å¯ç”¨
            try {
                await chrome.storage.local.get('user_settings');
                results.push({ name: 'Chrome Storage API', pass: true });
            } catch (error) {
                results.push({ name: 'Chrome Storage API', pass: false, error: error.message });
            }

            // æµ‹è¯• 2: DOM æ“ä½œ
            try {
                const root = document.documentElement;
                root.classList.add('test-class');
                const hasClass = root.classList.contains('test-class');
                root.classList.remove('test-class');
                results.push({ name: 'DOM Class æ“ä½œ', pass: hasClass });
            } catch (error) {
                results.push({ name: 'DOM Class æ“ä½œ', pass: false, error: error.message });
            }

            // æµ‹è¯• 3: Media Query æ”¯æŒ
            try {
                const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
                const supported = mediaQuery !== null;
                results.push({
                    name: 'Media Query æ”¯æŒ',
                    pass: supported,
                    extra: `System theme: ${mediaQuery.matches ? 'dark' : 'light'}`
                });
            } catch (error) {
                results.push({ name: 'Media Query æ”¯æŒ', pass: false, error: error.message });
            }

            // æ˜¾ç¤ºç»“æœ
            const resultsHTML = results.map(result => {
                const className = result.pass ? 'pass' : 'fail';
                const icon = result.pass ? 'âœ…' : 'âŒ';
                const extra = result.extra ? `<br><small>${result.extra}</small>` : '';
                const errorMsg = result.error ? `<br><small>Error: ${result.error}</small>` : '';
                return `
                    <div class="status ${className}">
                        ${icon} <strong>${result.name}</strong>: ${result.pass ? 'PASS' : 'FAIL'}
                        ${extra}${errorMsg}
                    </div>
                `;
            }).join('');

            document.getElementById('autoTestResults').innerHTML = resultsHTML;
        }

        // åˆå§‹åŒ–
        updateCurrentStatus();
        runAutoTests();

        // æ¯ç§’æ›´æ–°çŠ¶æ€ï¼ˆç›‘å¬å˜åŒ–ï¼‰
        setInterval(updateCurrentStatus, 1000);

        console.log('ğŸ¨ Theme Test Page Ready!');
        console.log('ğŸ“‹ Use buttons to test theme switching');
    </script>
</body>
</html>
