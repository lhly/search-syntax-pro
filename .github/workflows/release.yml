# ============================================================================
# SearchSyntax Pro - è‡ªåŠ¨åŒ–æ„å»ºä¸å‘å¸ƒå·¥ä½œæµ
# ============================================================================
#
# åŠŸèƒ½ï¼š
# - è‡ªåŠ¨æ„å»ºå’Œæµ‹è¯• Chrome æ‰©å±•
# - ç”Ÿæˆå¯å‘å¸ƒçš„ ZIP åŒ…
# - åˆ›å»º GitHub Releaseï¼ˆTag è§¦å‘æ—¶ï¼‰
#
# è§¦å‘æ¡ä»¶ï¼š
# - Tag æ¨é€ï¼ˆv*.*.*ï¼‰ï¼šå®Œæ•´å‘å¸ƒæµç¨‹
# - Main åˆ†æ”¯æ¨é€ï¼šæŒç»­é›†æˆéªŒè¯
# - Pull Requestï¼šä»£ç å®¡æŸ¥éªŒè¯
#
# ä½œè€…ï¼šSearchSyntax Pro Team
# æœ€åæ›´æ–°ï¼š2025-11-10
# ============================================================================

name: Build and Release

on:
  # Tag æ¨é€æˆ– Main åˆ†æ”¯æ¨é€è§¦å‘
  push:
    tags:
      - 'v*.*.*'  # Tag æ¨é€ï¼šè§¦å‘å®Œæ•´å‘å¸ƒæµç¨‹
    branches:
      - main      # Main åˆ†æ”¯æ¨é€ï¼šè§¦å‘ CI éªŒè¯

  # Pull Request è§¦å‘éªŒè¯
  pull_request:
    branches:
      - main

# å·¥ä½œæµæƒé™é…ç½®
permissions:
  contents: write  # éœ€è¦å†™æƒé™æ¥åˆ›å»º Release
  pull-requests: read

jobs:
  # ==========================================================================
  # Job 1: æ„å»ºå’Œæµ‹è¯•
  # ==========================================================================
  build-and-test:
    name: ğŸ”¨ Build and Test
    runs-on: ubuntu-latest

    steps:
      # -------------------- ç¯å¢ƒå‡†å¤‡ --------------------

      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      # -------------------- ä¾èµ–ç®¡ç† --------------------

      - name: ğŸ“¦ Cache dependencies
        uses: actions/cache@v3
        with:
          path: |
            node_modules
            ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: ğŸ”§ Install dependencies
        run: npm ci

      # -------------------- ä»£ç è´¨é‡æ£€æŸ¥ï¼ˆå¹¶è¡Œï¼‰ --------------------

      - name: ğŸ“‹ Type check
        run: npm run type-check

      - name: ğŸ” Lint code
        run: npm run lint
        continue-on-error: true  # å…è®¸ lint è­¦å‘Šä¸é˜»æ­¢æ„å»º

      - name: ğŸ§ª Run unit tests
        run: npm run test
        continue-on-error: true  # å¯é…ç½®ä¸ºä¸¥æ ¼æ¨¡å¼

      # -------------------- ç‰ˆæœ¬ä¸€è‡´æ€§éªŒè¯ --------------------

      - name: âœ… Verify version consistency
        run: node scripts/check-version.js

      # -------------------- æ„å»º --------------------

      - name: ğŸ—ï¸ Build extension
        run: npm run build

      # -------------------- ä¸Šä¼ æ„å»ºäº§ç‰© --------------------

      - name: ğŸ“¤ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist-${{ github.sha }}
          path: dist/
          retention-days: 90
          if-no-files-found: error

  # ==========================================================================
  # Job 2: æ‰“åŒ…ï¼ˆä¾èµ–æ„å»ºæˆåŠŸï¼‰
  # ==========================================================================
  package:
    name: ğŸ“¦ Create Package
    runs-on: ubuntu-latest
    needs: build-and-test

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      # -------------------- ä¸‹è½½æ„å»ºäº§ç‰© --------------------

      - name: ğŸ“¥ Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist-${{ github.sha }}
          path: dist/

      # -------------------- æ‰§è¡Œæ‰“åŒ… --------------------

      - name: ğŸ Create ZIP package
        run: |
          # å®‰è£…ä¾èµ–ï¼ˆä»…éœ€ package.js æ‰€éœ€çš„æ¨¡å—ï¼‰
          npm ci --only=production

          # æ‰§è¡Œæ‰“åŒ…è„šæœ¬
          npm run package:only

          # éªŒè¯ ZIP æ–‡ä»¶ç”Ÿæˆ
          if [ ! -f releases/*.zip ]; then
            echo "âŒ ZIP æ–‡ä»¶ç”Ÿæˆå¤±è´¥"
            exit 1
          fi

          # æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
          ls -lh releases/*.zip

      # -------------------- ä¸Šä¼  ZIP åŒ… --------------------

      - name: ğŸ“¤ Upload ZIP package
        uses: actions/upload-artifact@v4
        with:
          name: extension-package-${{ github.sha }}
          path: releases/*.zip
          retention-days: 90
          if-no-files-found: error

  # ==========================================================================
  # Job 3: å‘å¸ƒï¼ˆä»… Tag è§¦å‘ï¼‰
  # ==========================================================================
  release:
    name: ğŸš€ Create GitHub Release
    runs-on: ubuntu-latest
    needs: package
    if: startsWith(github.ref, 'refs/tags/v')  # ä»…åœ¨ Tag æ¨é€æ—¶æ‰§è¡Œ

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ç”¨äºç”Ÿæˆæ›´æ–°æ—¥å¿—

      # -------------------- ä¸‹è½½ ZIP åŒ… --------------------

      - name: ğŸ“¥ Download package
        uses: actions/download-artifact@v4
        with:
          name: extension-package-${{ github.sha }}
          path: releases/

      # -------------------- æå–ç‰ˆæœ¬ä¿¡æ¯ --------------------

      - name: ğŸ“‹ Extract version info
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“Œ Version: $VERSION"

          # éªŒè¯ç‰ˆæœ¬å·æ ¼å¼
          if ! [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.]+)?$ ]]; then
            echo "âŒ æ— æ•ˆçš„ç‰ˆæœ¬å·æ ¼å¼: $VERSION"
            exit 1
          fi

      # -------------------- ç”Ÿæˆæ›´æ–°æ—¥å¿— --------------------

      - name: ğŸ“ Generate changelog
        id: changelog
        run: |
          # è·å–ä¸Šä¸€ä¸ª tag
          PREVIOUS_TAG=$(git describe --abbrev=0 --tags $(git rev-list --tags --skip=1 --max-count=1) 2>/dev/null || echo "")

          if [ -z "$PREVIOUS_TAG" ]; then
            echo "è¿™æ˜¯é¦–ä¸ªå‘å¸ƒç‰ˆæœ¬"
            CHANGELOG="åˆå§‹ç‰ˆæœ¬å‘å¸ƒ"
          else
            echo "ç”Ÿæˆä» $PREVIOUS_TAG åˆ°å½“å‰ç‰ˆæœ¬çš„æ›´æ–°æ—¥å¿—"
            CHANGELOG=$(git log $PREVIOUS_TAG..HEAD --pretty=format:"- %s (%h)" --no-merges)
          fi

          # è¾“å‡ºåˆ°æ–‡ä»¶ï¼ˆæ”¯æŒå¤šè¡Œï¼‰
          echo "$CHANGELOG" > /tmp/changelog.txt
          echo "changelog_file=/tmp/changelog.txt" >> $GITHUB_OUTPUT

      # -------------------- åˆ›å»º GitHub Release --------------------

      - name: ğŸ‰ Create Release
        uses: softprops/action-gh-release@v1
        with:
          draft: true  # åˆ›å»ºè‰ç¨¿ï¼Œå…è®¸äººå·¥å®¡æŸ¥
          prerelease: ${{ contains(github.ref, '-') }}  # æ£€æµ‹é¢„å‘å¸ƒç‰ˆæœ¬ï¼ˆå¦‚ v1.0.0-betaï¼‰
          files: releases/*.zip
          generate_release_notes: true  # è‡ªåŠ¨ç”Ÿæˆå‘å¸ƒè¯´æ˜
          body: |
            ## ğŸ‰ SearchSyntax Pro v${{ steps.version.outputs.version }} å‘å¸ƒ

            ### ğŸ“¦ å®‰è£…æ–¹æ³•

            #### å¼€å‘è€…æ¨¡å¼å®‰è£…ï¼ˆç«‹å³ä½“éªŒï¼‰
            1. ä¸‹è½½ä¸‹æ–¹çš„ `ssp-v${{ steps.version.outputs.version }}.zip` æ–‡ä»¶
            2. è§£å‹åˆ°æœ¬åœ°ç›®å½•
            3. åœ¨ Chrome æµè§ˆå™¨ä¸­è®¿é—® `chrome://extensions/`
            4. å¼€å¯å³ä¸Šè§’çš„ **"å¼€å‘è€…æ¨¡å¼"**
            5. ç‚¹å‡» **"åŠ è½½å·²è§£å‹çš„æ‰©å±•ç¨‹åº"**
            6. é€‰æ‹©è§£å‹åçš„ç›®å½•

            #### Chrome åº”ç”¨å•†åº—å®‰è£…ï¼ˆæ¨èï¼‰
            ğŸ“¢ æœ¬ç‰ˆæœ¬å°†åœ¨å®¡æ ¸é€šè¿‡åå‘å¸ƒåˆ° Chrome Web Store

            ### âœ¨ æ›´æ–°å†…å®¹

            ${{ steps.changelog.outputs.changelog_file && format('è¯¦è§ä¸‹æ–¹è‡ªåŠ¨ç”Ÿæˆçš„æ›´æ–°æ—¥å¿—') || 'è¯·æŸ¥çœ‹æäº¤å†å²' }}

            ### ğŸ”§ æŠ€æœ¯ä¿¡æ¯

            - **æ„å»ºæ—¶é—´**ï¼š${{ github.event.head_commit.timestamp }}
            - **æäº¤å“ˆå¸Œ**ï¼š`${{ github.sha }}`
            - **Node.js ç‰ˆæœ¬**ï¼š18.x
            - **æ„å»ºç¯å¢ƒ**ï¼šGitHub Actions (ubuntu-latest)

            ### ğŸ“Š æ–‡ä»¶ä¿¡æ¯

            | æ–‡ä»¶ | è¯´æ˜ |
            |------|------|
            | `ssp-v${{ steps.version.outputs.version }}.zip` | Chrome æ‰©å±•å®‰è£…åŒ… |

            ### ğŸ› é—®é¢˜åé¦ˆ

            å¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·æäº¤ [Issue](https://github.com/lhly/search-syntax-pro/issues)

            ---

            ğŸ¤– è‡ªåŠ¨æ„å»ºç”Ÿæˆ via GitHub Actions
            ğŸ“… å‘å¸ƒæ—¶é—´ï¼š${{ github.event.head_commit.timestamp }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # -------------------- å‘å¸ƒæˆåŠŸé€šçŸ¥ --------------------

      - name: âœ… Release created
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… å‘å¸ƒæˆåŠŸï¼"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸ“¦ ç‰ˆæœ¬: v${{ steps.version.outputs.version }}"
          echo "ğŸ”— æŸ¥çœ‹å‘å¸ƒ: https://github.com/${{ github.repository }}/releases"
          echo ""
          echo "âš ï¸  æ³¨æ„: Release å¤„äºè‰ç¨¿çŠ¶æ€ï¼Œè¯·å‰å¾€ä»¥ä¸‹é“¾æ¥å®¡æŸ¥åå‘å¸ƒï¼š"
          echo "   https://github.com/${{ github.repository }}/releases"
          echo ""
          echo "ğŸš€ åç»­æ­¥éª¤:"
          echo "   1. åœ¨ Releases é¡µé¢æ£€æŸ¥ ZIP æ–‡ä»¶å®Œæ•´æ€§"
          echo "   2. è¡¥å……å‘å¸ƒè¯´æ˜ï¼ˆå¯é€‰ï¼‰"
          echo "   3. ç‚¹å‡» 'Publish release' å‘å¸ƒ"
          echo "   4. ä¸‹è½½ ZIP ä¸Šä¼ åˆ° Chrome Web Store"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
